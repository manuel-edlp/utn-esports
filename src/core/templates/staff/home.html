{% extends 'base.html' %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/staff/home.css' %}">
{% endblock %}

{% block main %}
<div class="staff-home-container">
    <h1>Panel de Staff - Gestión de Equipos</h1>

    <!-- Barra de busqueda y filtros -->
    <div class="filtros-busqueda">
        <form method="get" action="{% url 'staff_home' %}">
            <input type="text" name="search" placeholder="Buscar equipo..." value="{{ request.GET.search }}">
            <select name="estado">
                <option value="">Todos los estados</option>
                <option value="Aprobado" {% if request.GET.estado == "Aprobado" %}selected{% endif %}>Aprobado</option>
                <option value="Rechazado" {% if request.GET.estado == "Rechazado" %}selected{% endif %}>Rechazado</option>
                <option value="En revisión" {% if request.GET.estado == "En revisión" %}selected{% endif %}>En revisión</option>
                <option value="Pago pendiente" {% if request.GET.estado == "Pago pendiente" %}selected{% endif %}>Pago pendiente</option>
            </select>
            <button type="submit">Filtrar</button>
        </form>
    </div>

    <!-- Listado de equipos -->
    <div class="equipos-list">
        {% for equipo in equipos %}
        <div class="equipo-card">
            <div class="equipo-info">
                <img src="{{ equipo.logo.url }}" alt="{{ equipo.nombre }}" class="equipo-logo">
                <div class="equipo-details">
                    <h3>{{ equipo.nombre }} ({{ equipo.abreviatura }})</h3>
                    <p>Estado: <span class="estado-{{ equipo.estadoAprobacion|slugify }}">{{ equipo.estadoAprobacion }}</span></p>
                    {% if equipo.comprobante_pago %}
                        <a href="{{ equipo.comprobante_pago.url }}" target="_blank" class="btn-descargar">Descargar Comprobante</a>
                    {% else %}
                        <span class="btn-descargar disabled">Comprobante no disponible</span>
                    {% endif %}
                </div>
            </div>
            <div class="equipo-acciones">
                <!-- Fila superior: Aprobar y Rechazar -->
                <div class="botones-fila-superior">
                    <button onclick="cambiarEstado('{{ equipo.id }}', 'Aprobado')" class="btn-aprobar">Aprobar</button>
                    <button onclick="cambiarEstado('{{ equipo.id }}', 'En revisión')" class="btn-revision">En revisión</button>
                    <button onclick="cambiarEstado('{{ equipo.id }}', 'Rechazado')" class="btn-rechazar">Rechazar</button>
                </div>
                <!-- Fila inferior: Ver Integrantes -->
                <button onclick="mostrarIntegrantes('{{ equipo.id }}')" class="btn-integrantes">
                    <i class="fas fa-user-group"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

<!-- Paginación -->
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page=1" class="page-btn first" title="Primera página">
            &#171; <!-- Doble flecha izquierda -->
        </a>
        <a href="?page={{ page_obj.previous_page_number }}" class="page-btn prev" title="Página anterior">
            &#8249; <!-- Flecha izquierda -->
        </a>
    {% endif %}

    <span class="current">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="page-btn next" title="Página siguiente">
            &#8250; <!-- Flecha derecha -->
        </a>
        <a href="?page={{ page_obj.paginator.num_pages }}" class="page-btn last" title="Última página">
            &#187; <!-- Doble flecha derecha -->
        </a>
    {% endif %}
</div>

</div>



<!-- Modal para mostrar los integrantes -->
<div id="modal-integrantes" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="cerrarModal()">
            <i class="fa-solid fa-xmark"></i>
        </span>
        <h3>Integrantes del Equipo</h3>
        <ul id="lista-integrantes">
            <!-- Lista de integrantes -->
        </ul>
    </div>
</div>


<script>
function cambiarEstado(equipoId, nuevoEstado) {
    fetch("{% url 'staff_home' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `equipo_id=${equipoId}&nuevo_estado=${nuevoEstado}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        }
    });
}
</script>

<script>
function mostrarIntegrantes(equipoId) {
    fetch(`/staff/obtener_integrantes/${equipoId}/`)
        .then(response => response.json())
        .then(integrantes => {
            const listaIntegrantes = document.getElementById("lista-integrantes");
            listaIntegrantes.innerHTML = "";

            integrantes.forEach(integrante => {
                const li = document.createElement("li");
                li.textContent = integrante.nombre;
                if (integrante.esCapitan) {
                    const badge = document.createElement("span");
                    badge.className = "capitan-badge";
                    badge.textContent = "Capitán";
                    li.appendChild(badge);
                }
                listaIntegrantes.appendChild(li);
            });

            const modal = document.getElementById("modal-integrantes");
            modal.style.display = "block";
        })
        .catch(error => console.error('Error:', error));
}
l
function cerrarModal() {
    const modal = document.getElementById("modal-integrantes");
    modal.style.display = "none";
}

// Cierra el modal si se hace click fuera del contenido
window.onclick = function(event) {
    const modal = document.getElementById("modal-integrantes");
    if (event.target === modal) {
        modal.style.display = "none";
    }
};
    </script>


{% endblock %}